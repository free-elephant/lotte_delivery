{% extends 'base.html' %}
{%block title %}
<title>deliver page</title>
{% endblock title%}

{% block css %}
<style>
    .dot {
        overflow: hidden;
        float: left;
        width: 12px;
        height: 12px;
        background: url('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/mini_circle.png');
    }

    .dotOverlay {
        position: relative;
        bottom: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        border-bottom: 2px solid #ddd;
        float: left;
        font-size: 12px;
        padding: 5px;
        background: #fff;
    }

    .dotOverlay:nth-of-type(n) {
        border: 0;
        box-shadow: 0px 1px 2px #888;
    }

    .number {
        font-weight: bold;
        color: #ee6152;
    }

    .dotOverlay:after {
        content: '';
        position: absolute;
        margin-left: -6px;
        left: 50%;
        bottom: -8px;
        width: 11px;
        height: 8px;
        background: url('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/vertex_white_small.png')
    }

    .distanceInfo {
        position: relative;
        top: 5px;
        left: 5px;
        list-style: none;
        margin: 0;
    }

    .distanceInfo .label {
        display: inline-block;
        width: 50px;
    }

    .distanceInfo:after {
        content: none;
    }
    fieldset {
        border: 0;
        padding: 0;
    }
    fieldset legend {
        padding: 20px 0 10px;
        font-weight: bold;
    }
</style>
{% endblock css %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>
<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
{% endblock scripts %}

{% block content %}
<p>===== deliver 페이지 접속시 -> 버튼 3개가 있음 -> 1.현재위치기반 , 2. 네비게이션, 3. 반경 조절 select box</p>
<p>1. 현재위치기반으로 반경 x km 안에 있는 마크 확인 + 반경 조절 <span style="color :red; bold;"><strong>(완료)</strong></span></p>
<p>2. 네비게이션? 출발위치와 도착위치의 반경 x km 안에 있는 마크 확인</p>
-> deliver 페이지에 들어
<p>3. 반경조절 select box</p>
<div>
    <fieldset>
        <legend>출발 주소</legend>

        <input type="text" id="sample6_postcode" placeholder="우편번호" readonly>
        <input type="button" onclick="sample6_execDaumPostcode()" value="우편번호찾기"><br>
        <input type="text" id="sample6_address" placeholder="주소" style="width:352px;" readonly><br>

        <input type="text" id="sample6_detailAddress" placeholder="상세주소">
        <input type="text" id="sample6_extraAddress" placeholder="참고주소" readonly><br>
        <input type="text" placeholder="휴대전화">
    </fieldset>

</div>

<div>
    <p>도착지</p>
    도착지 주소: <input type="text" id="destination" placeholder="주소">
    <input type="button" onclick="my_Stuff_Map(this.id)" value="주소 검색" id="map_destination"><br>
    도착지 상세주소 : <input type="text">
    <br>
    수취인 번호 : <input type="text">
</div>

<script>
    function sample6_execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function (data) {
                // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.

                // 각 주소의 노출 규칙에 따라 주소를 조합한다.
                // 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
                var addr = ''; // 주소 변수
                var extraAddr = ''; // 참고항목 변수

                //사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
                if (data.userSelectedType === 'R') { // 사용자가 도로명 주소를 선택했을 경우
                    addr = data.roadAddress;
                } else { // 사용자가 지번 주소를 선택했을 경우(J)
                    addr = data.jibunAddress;
                }

                // 사용자가 선택한 주소가 도로명 타입일때 참고항목을 조합한다.
                if (data.userSelectedType === 'R') {
                    // 법정동명이 있을 경우 추가한다. (법정리는 제외)
                    // 법정동의 경우 마지막 문자가 "동/로/가"로 끝난다.
                    if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) {
                        extraAddr += data.bname;
                    }
                    // 건물명이 있고, 공동주택일 경우 추가한다.
                    if (data.buildingName !== '' && data.apartment === 'Y') {
                        extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    // 표시할 참고항목이 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
                    if (extraAddr !== '') {
                        extraAddr = ' (' + extraAddr + ')';
                    }
                    // 조합된 참고항목을 해당 필드에 넣는다.
                    document.getElementById("sample6_extraAddress").value = extraAddr;

                } else {
                    document.getElementById("sample6_extraAddress").value = '';
                }

                // 우편번호와 주소 정보를 해당 필드에 넣는다.
                document.getElementById('sample6_postcode').value = data.zonecode;
                document.getElementById("sample6_address").value = addr;
                // 커서를 상세주소 필드로 이동한다.
                document.getElementById("sample6_detailAddress").focus();
            }
        }).open();
    }
</script>

<select name="select_radius" id="select_radius">
    <option value="1000">1km</option>
    <option value="2000">2km</option>
    <option value="3000">3km</option>
    <option value="4000">4km</option>
    <option value="5000">5km</option>
</select>
<div id="map" style="width:500px;height:400px;"></div>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=f92e2590928afb34663522ac2201a7be">
</script>
<script>
    var container = document.getElementById('map');
    var options = {
        center: new kakao.maps.LatLng(33.450701, 126.570667),
        level: 6
    };
    var map = new kakao.maps.Map(container, options);
    var markersInCircle = [];
    var circle;
    var r;
    var newPosition;
    // ----------------------------------------------------------gps----------------------------------------------------------
    (function () {
        if (navigator.geolocation) {
            // GeoLocation을 이용해서 접속 위치를 얻어옵니다
            navigator.geolocation.getCurrentPosition(function (position) {
                var lat = position.coords.latitude, // 위도
                    lon = position.coords.longitude; // 경도

                var locPosition = new kakao.maps.LatLng(lat,
                    lon); // 마커가 표시될 위치를 geolocation으로 얻어온 좌표로 생성합니다
                newPosition = locPosition;
                map.setCenter(locPosition); //gps 위치로 이동

                circle = new kakao.maps.Circle({ //시작 원 반경 출력
                    center: locPosition,
                    radius: 1000,
                    strokeWeight: 1,
                    strokeColor: '#ff00ff',
                    strokeOpacity: 1,
                    strokeStyle: 'solid',
                    fillColor: '#ff00ff',
                    fillOpacity: 0.2
                });
                circle.setMap(map);

                var ce = circle.getPosition(); //시작 원의 중심 좌표
                var ra = circle.getRadius(); //시작 원의 반경
                var line = new kakao.maps.Polyline();

                markers.forEach(function (
                    marker) { // 시작원의 반경과 원의중심점과 마커의 거리를 구함. 반경>마커 : 원의 내부 / 반경<마커 : 원의 외부
                    var path = [marker.getPosition(), ce];
                    line.setPath(path);
                    var dist = line.getLength();
                    if (dist < ra) {
                        console.log("시작 반경 안의 Lat : " + marker.getPosition().getLat());
                        console.log("시작 반경 안의 Lng : " + marker.getPosition().getLng());
                        markersInCircle.push(marker);
                    }
                });

                //console.log('result : ', markersInCircle);
            });

        } else {

            var locPosition = new kakao.maps.LatLng(33.450701, 126.570667),
                message = 'geolocation을 사용할수 없어요..'
            map.setCenter(locPosition);
        }
    }());
    // ----------------------------------------------------------gps끝----------------------------------------------------------
    //반경 변경
    $('#select_radius').click(function () {
        var select_radius = $('#select_radius').val()
        $.ajax({
            url: "{% url 'changeradius' %}",
            data: {
                'select_radius': select_radius
            },
            type: 'GET',
            dataType: 'json',
            success: function (response) { //ajax써서 값을 변경함
                circle.setMap(null); // 기존에 있던 원 삭제함
                circle = new kakao.maps.Circle({ //새로운 원 반경 출력
                    center: newPosition,
                    radius: response.radius,
                    strokeWeight: 1,
                    strokeColor: '#ff00ff',
                    strokeOpacity: 1,
                    strokeStyle: 'solid',
                    fillColor: '#ff00ff',
                    fillOpacity: 0.2
                });
                circle.setMap(map);

                var ce = circle.getPosition();
                var ra = circle.getRadius();
                var line = new kakao.maps.Polyline();

                console.log("----");
                markers.forEach(function (marker) {
                    var path = [marker.getPosition(), ce];
                    line.setPath(path);
                    var dist = line.getLength();
                    if (dist < ra) {
                        console.log("반경 안의 Lat : " + marker.getPosition().getLat());
                        console.log("반경 안의 Lng : " + marker.getPosition().getLng());
                        markersInCircle.push(marker);
                    }
                });
                console.log("----");
                return;
            },
            error: function (xhr, error) {
                alert("서버와의 통신에서 문제가 발생했습니다.");
                console.error("error : " + error);
            }
        })
    });
    //반경 변경


    var drawingFlag = false;
    var clickLine;
    var distanceOverlay;
    var dots = [];
    var i = 0;
    var markers = [];

    //pos1 = new kakao.maps.LatLng(36.36024443564978, 127.39317209119733);
    //pos2 = new kakao.maps.LatLng(36.36235638929254, 127.40833590649049);
    //pos3 = new kakao.maps.LatLng(36.35485724173146, 127.40874237467911);
    pos1 = new kakao.maps.LatLng(35.85664412729865, 128.71591409783503);
    pos2 = new kakao.maps.LatLng(35.84343906780063, 128.7492747430529);
    pos3 = new kakao.maps.LatLng(35.84822862919346, 128.76190906797555);
    addMarker(pos1);
    addMarker(pos2);
    addMarker(pos3);

    clickLine = new kakao.maps.Polyline({ //마크에 점표시 (첫번쨰마크)
        map: map,
        path: [pos1],
        strokeWeight: 3,
        strokeColor: '#db4040',
        strokeOpacity: 1,
        strokeStyle: 'solid'
    });
    displayCircleDot(pos1, 0);

    //경유지점
    var path = clickLine.getPath(); //두번째 마크
    path.push(pos2);

    clickLine.setPath(path);

    var distance = Math.round(clickLine.getLength());
    displayCircleDot(pos2, distance);


    //도착지점
    var path = clickLine.getPath(); // 세번째 마크
    path.push(pos3);

    clickLine.setPath(path);

    var distance = Math.round(clickLine.getLength());
    displayCircleDot(pos3, distance);

    //마무리 (총 거리, 도보, 자전거표시해줌 )
    if (dots[dots.length - 1].distance) {
        dots[dots.length - 1].distance.setMap(null);
        dots[dots.length - 1].distance = null;
    }

    var distance = Math.round(clickLine.getLength()),
        content = getTimeHTML(distance);

    showDistance(content, path[path.length - 1]);



    function showDistance(content, position) {

        if (distanceOverlay) {
            distanceOverlay.setPosition(position);
            distanceOverlay.setContent(content);

        } else {
            distanceOverlay = new kakao.maps.CustomOverlay({
                map: map,
                content: content,
                position: position,
                xAnchor: 0,
                yAnchor: 0,
                zIndex: 3
            });
        }
    }


    function displayCircleDot(position, distance) { // 인포윈도우로 거리 표시해줌
        var circleOverlay = new kakao.maps.CustomOverlay({
            content: '<span class="dot"></span>',
            position: position,
            zIndex: 1
        });

        circleOverlay.setMap(map);

        if (distance > 0) {
            var distanceOverlay = new kakao.maps.CustomOverlay({
                content: '<div class="dotOverlay">거리 <span class="number">' + distance + '</span>m</div>',
                position: position,
                yAnchor: 1,
                zIndex: 2
            });

            distanceOverlay.setMap(map);
        }

        dots.push({
            circle: circleOverlay,
            distance: distanceOverlay
        });
    }
    // 마커를 생성하고 지도위에 표시하는 함수입니다
    function addMarker(position) {

        // 마커를 생성합니다
        var marker = new kakao.maps.Marker({
            position: position
        });
        //console.log("마커 : " + marker);
        // 마커가 지도 위에 표시되도록 설정합니다
        marker.setMap(map);

        // 생성된 마커를 배열에 추가합니다
        markers.push(marker);
        var p = position;
        console.log("Lat : " + position.getLat());
        console.log("Lng : " + position.getLng());
        var resultDiv = document.getElementById('result');
        // resultDiv.innerHTML = resultDiv.innerHTML + " " + p;
        //console.log(p);
    }



    function getTimeHTML(distance) { //총 거리가 얼마나 되는지 알려줌

        // 도보의 시속은 평균 4km/h 이고 도보의 분속은 67m/min입니다
        var walkkTime = distance / 67 | 0;
        var walkHour = '',
            walkMin = '';

        // 계산한 도보 시간이 60분 보다 크면 시간으로 표시합니다
        if (walkkTime > 60) {
            walkHour = '<span class="number">' + Math.floor(walkkTime / 60) + '</span>시간 '
        }
        walkMin = '<span class="number">' + walkkTime % 60 + '</span>분'

        // 자전거의 평균 시속은 16km/h 이고 이것을 기준으로 자전거의 분속은 267m/min입니다
        var bycicleTime = distance / 227 | 0;
        var bycicleHour = '',
            bycicleMin = '';

        // 계산한 자전거 시간이 60분 보다 크면 시간으로 표출합니다
        if (bycicleTime > 60) {
            bycicleHour = '<span class="number">' + Math.floor(bycicleTime / 60) + '</span>시간 '
        }
        bycicleMin = '<span class="number">' + bycicleTime % 60 + '</span>분'

        // 거리와 도보 시간, 자전거 시간을 가지고 HTML Content를 만들어 리턴합니다
        var content = '<ul class="dotOverlay distanceInfo">';
        content += '    <li>';
        content += '        <span class="label">총거리</span><span class="number">' + distance + '</span>m';
        content += '    </li>';
        content += '    <li>';
        content += '        <span class="label">도보</span>' + walkHour + walkMin;
        content += '    </li>';
        content += '    <li>';
        content += '        <span class="label">자전거</span>' + bycicleHour + bycicleMin;
        content += '    </li>';
        content += '</ul>'

        return content;
    }
</script>




{% endblock content %}